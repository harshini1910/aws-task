---
- name: Configure web servers and deploy app
  hosts: web
  become: yes
  vars:
    app_version: "v1"
    repo_url: "https://github.com/<your-username>/aws-capstone-exam.git"
    rds_endpoint: "<RDS_ENDPOINT_FROM_TERRAFORM>"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Apache, PHP, Git, MySQL client
      apt:
        name:
          - apache2
          - php
          - libapache2-mod-php
          - php-mysql
          - git
          - mysql-client
        state: present

    - name: Ensure apache is running
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Clean old site content
      file:
        path: /var/www/html
        state: absent

    - name: Recreate html directory
      file:
        path: /var/www/html
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Clone repository
      git:
        repo: "{{ repo_url }}"
        dest: /tmp/apprepo
        version: dev
        force: yes

    - name: Copy app version to web root
      copy:
        src: "/tmp/apprepo/app/{{ app_version }}/"
        dest: /var/www/html/
        remote_src: yes

    - name: Create db_check.php (optional)
      copy:
        dest: /var/www/html/db_check.php
        content: |
          <?php
          $host = "{{ rds_endpoint }}";
          $user = "adminuser";
          $pass = "YourStrongPass123!";
          $conn = new mysqli($host, $user, $pass);
          if ($conn->connect_error) { die("DB Connection Failed"); }
          echo "Database Connected Successfully";
          ?>
